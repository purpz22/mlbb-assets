<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MLBB Guess Hero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Rajdhani', sans-serif; background: #0f172a; color: white; overflow-x: hidden; user-select: none; }
        .glass { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        .hero-box { width: 220px; height: 220px; border: 4px solid #fbbf24; border-radius: 16px; margin: 0 auto; overflow: hidden; background: black; position: relative; display: flex; align-items: center; justify-content: center; }
        .hero-box img { width: 100%; height: 100%; object-fit: contain; }
        
        .timer-container { width: 100%; height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-bottom: 15px; }
        .timer-bar { height: 100%; background: #4ade80; width: 100%; transition: width 0.1s linear; }
        
        .input-field { background: #1e293b; border: 2px solid #334155; color: white; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: #fbbf24; }
        .hidden { display: none !important; }
        
        .btn { background: linear-gradient(to bottom, #3b82f6, #1d4ed8); border: 1px solid #60a5fa; color: white; font-weight: bold; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-gold { background: linear-gradient(to bottom, #f59e0b, #b45309); border-color: #fbbf24; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- LOGIN SCREEN -->
    <div id="screen-login" class="glass w-full max-w-sm p-6 z-10 text-center">
        <h1 class="text-4xl font-black italic text-yellow-400 mb-6 drop-shadow-md">GUESS THE HERO</h1>
        <div class="flex gap-2 mb-4">
            <input type="number" id="login-id" placeholder="Game ID" class="input-field w-2/3 p-3 rounded-lg text-lg text-center">
            <input type="number" id="login-zone" placeholder="Zone" class="input-field w-1/3 p-3 rounded-lg text-lg text-center">
        </div>
        <p id="login-msg" class="text-red-400 text-xs mb-4 min-h-[16px] font-bold"></p>
        <button onclick="login()" id="btn-login" class="btn btn-gold w-full p-4 rounded-xl text-xl">CONNECT</button>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="glass w-full max-w-sm p-6 z-10 hidden relative">
        <div class="flex justify-between items-center border-b border-white/10 pb-2 mb-2">
            <div><span class="text-xs text-gray-400 block uppercase">Player</span><span id="player-ign" class="font-bold text-blue-400">Name</span></div>
            <div class="text-right"><span class="text-xs text-gray-400 block uppercase">Score</span><span id="player-score" class="font-black text-3xl text-yellow-400">0</span></div>
        </div>

        <div class="flex justify-between text-xs text-gray-400 mb-1">
            <span>TIME LEFT</span>
            <span id="timer-text" class="text-white font-bold">15s</span>
        </div>
        <div class="timer-container">
            <div id="timer-bar" class="timer-bar"></div>
        </div>
        
        <div class="hero-box mb-4" id="hero-box">
            <img id="hero-img" src="" onerror="this.style.display='none'; document.getElementById('debug-msg').innerText='Image Missing: ' + this.getAttribute('src');">
            <div id="debug-msg" class="absolute inset-0 flex items-center justify-center text-red-500 text-xs font-bold text-center px-4 break-words pointer-events-none"></div>
        </div>
        
        <p id="feedback" class="text-center font-bold text-lg h-6 mb-2 text-green-400"></p>

        <form onsubmit="checkGuess(event)" class="flex flex-col gap-2 mb-4">
            <input type="text" id="guess-input" placeholder="HERO NAME" class="input-field w-full p-3 rounded-xl text-center text-xl uppercase font-bold" autocomplete="off">
            <button type="submit" id="btn-submit" class="btn w-full p-3 rounded-xl text-lg">SUBMIT</button>
        </form>

        <button onclick="showLeaderboard()" class="text-xs text-gray-400 mt-2 underline w-full text-center hover:text-white">View Leaderboard</button>
    </div>

    <!-- LEADERBOARD SCREEN -->
    <div id="screen-leaderboard" class="glass w-full max-w-sm p-6 z-20 hidden absolute top-4 bottom-4 flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-black text-yellow-400 italic">TOP 5 PLAYERS</h2>
            <button onclick="closeLeaderboard()" class="text-xs text-gray-400 uppercase">Close X</button>
        </div>
        <div class="bg-slate-900 rounded-lg p-2 mb-4 flex-1">
            <table class="w-full text-left text-sm"><tbody id="lb-body"><tr><td class="text-center text-gray-500 py-4">Loading...</td></tr></tbody></table>
        </div>
        <div class="border-t border-white/10 pt-4">
            <p class="text-xs text-gray-400 uppercase mb-2">Search Rank by ID</p>
            <div class="flex gap-2">
                <input type="number" id="search-id" placeholder="Enter Game ID" class="input-field flex-1 p-2 rounded text-center">
                <button onclick="searchPlayer()" class="btn px-4 rounded">Search</button>
            </div>
            <div id="search-result" class="mt-4 text-center bg-slate-800 p-3 rounded hidden border border-blue-500">
                <p id="search-rank" class="text-2xl font-black text-white">#0</p>
                <p id="search-details" class="text-sm font-bold text-yellow-400 mt-1">IGN - 0 pts</p>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // ⚠️ PASTE YOUR FIREBASE KEYS HERE ⚠️
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
  authDomain: "guesshero-e1180.firebaseapp.com",
  databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "guesshero-e1180",
  storageBucket: "guesshero-e1180.firebasestorage.app",
  messagingSenderId: "274899168100",
  appId: "1:274899168100:web:da9798cf93110516d8e871"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ==========================================
        // HERO DATA GENERATION
        // ==========================================
        function normalizeName(name) {
            return name.toLowerCase().replace(/[' .]/g, '-').replace(/\.+$/, '');
        }

        const uniqueHeroNames = new Set([
            "Lunox", "Luo Yi", "Zhuxin", "Chip", "Cici", "Nolan", "Arlott", "Novaria", "Joy", "Fredrinn", 
            "Julian", "Xavier", "Melissa", "Yin", "Floryn", "Edith", "Valentina", "Aamon", "Aulus", "Natan", 
            "Phoveus", "Beatrix", "Gloo", "Paquito", "Mathilda", "Yve", "Brody", "Barats", "Khaleed", "Benedetta", 
            "Atlas", "Carmilla", "Cecilion", "Silvanna", "Wanwan", "Masha", "Baxia", "Ling", "X.borg", "Terizla", 
            "Esmeralda", "Guinevere", "Granger", "Khufra", "Badang", "Faramis", "Kadita", "Minotaur", "Hanzo", 
            "Claude", "Aldous", "Selena", "Kaja", "Chang'e", "Thamuz", "Kimmy", "Belerick", "Leomord", "Vale", 
            "Hanabi", "Uranus", "Martis", "Valir", "Gusion", "Angela", "Jawhead", "Lesley", "Pharsa", "Helcurt", 
            "Zhask", "Hylos", "Diggie", "Lancelot", "Odette", "Argus", "Grock", "Irithel", "Harley", "Gatotkaca", 
            "Roger", "Vexana", "Lapu-Lapu", "Aurora", "Hilda", "Estes", "Cyclops", "Johnson", "Moskov", 
            "Yi Sun shin", "Ruby", "Alpha", "Sun", "Chou", "Kagura", "Natalia", "Gord", "Freya", "Hayabusa", 
            "Lolita", "Layla", "Zilong", "Eudora", "Rafaela", "Clint", "Bruno", "Bane", "Franco", "Akai", "Karina", 
            "Alucard", "Miya", "Saber", "Balmond", "Nana", "Alice", "Zetian", "Sora", "Obsedia"
        ]);

        const allSkinSeriesTypes = [
            "kof1", "kof2", "kof3", "V.E.N.O.M", "attack-on-titan", "hunterxhunter", "11.11skin", 
            "PRIME", "abyss", "lightborn", "dragon-tamer", "zodiac", "ducati", "transformers", 
            "sanrio", "starwars", "naruto", "blazing-bounties", "dawning-stars", "exorcists", 
            "the-aspirants", "halloween", "summer", "mpl", "kung-fu-panda", "christmas", 
            "valentine", "legends-skin", "neobeasts", "jujutsu-kaisen", "saint-seiya", "lunar-fest", 
            "champion", "M-WORLD", "s.a.b.e.r", "epic", "special" 
        ];

        const predefinedSeriesSkins = [
            { "name": "Chou", "skill_type": "kof1", "icon_path": "icons/chou-kof1.png" },
            { "name": "Gusion", "skill_type": "kof2", "icon_path": "icons/gusion-KOF2.png" },
            { "name": "Guinevere", "skill_type": "kof1", "icon_path": "icons/guinevere-kof1.png" },
            { "name": "Karina", "skill_type": "kof1", "icon_path": "icons/karina-kof1.png" }
            // Add more skins here...
        ];

        let heroes = [];
        
        // 1. Generate Normal Hero Paths
        uniqueHeroNames.forEach(heroName => {
            if (heroName === "Fanny") return;
            const baseName = normalizeName(heroName);
            // This assumes your folder has files like: icons/aamon-ss.webp
            heroes.push({ name: heroName, icon_path: `icons/${baseName}-ss.webp` });
            heroes.push({ name: heroName, icon_path: `icons/${baseName}-1st.png` });
            heroes.push({ name: heroName, icon_path: `icons/${baseName}-icon.webp` });
        });

        // 2. Add Special Skins
        predefinedSeriesSkins.forEach(skin => {
            heroes.push({ name: skin.name, icon_path: skin.icon_path });
        });

        // ==========================================
        // GAME STATE
        // ==========================================
        let currentUser = { id: "", ign: "", score: 0 };
        let currentHero = null;
        let timerInterval;
        let timeLeft = 15;
        let isGameActive = false;

        // --- LOGIN ---
        window.login = async function() {
            const id = document.getElementById('login-id').value.trim();
            const zone = document.getElementById('login-zone').value.trim();
            const msg = document.getElementById('login-msg');

            if(!id || !zone) return msg.innerText = "Enter ID and Zone";
            msg.innerText = "Verifying Account...";

            try {
                // 1. Verify with MLBB API (using proxy)
                let res = await fetch(`https://corsproxy.io/?https://api.isan.eu.org/nickname/ml?id=${id}&zone=${zone}`);
                let data = await res.json();
                
                if(!data.success && !data.name) return msg.innerText = "Invalid ID or Zone";
                
                currentUser.id = id;
                currentUser.ign = data.name || data.nickname;
                msg.innerText = "Loading Score...";

                // 2. Get Score from Firebase
                const userDoc = await getDoc(doc(db, "players", id));
                if(userDoc.exists()) currentUser.score = userDoc.data().score;
                else currentUser.score = 0;

                // 3. Start Game
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('hidden');
                document.getElementById('player-ign').innerText = currentUser.ign;
                document.getElementById('player-score').innerText = currentUser.score;
                
                nextHero();

            } catch(e) { msg.innerText = "Error: " + e.message; }
        }

        // --- GAME FLOW ---
        window.nextHero = function() {
            // Reset UI
            document.getElementById('guess-input').value = "";
            document.getElementById('guess-input').disabled = false;
            document.getElementById('btn-submit').disabled = false;
            document.getElementById('guess-input').focus();
            document.getElementById('feedback').innerText = "";
            document.getElementById('debug-msg').innerText = "";
            
            const imgEl = document.getElementById('hero-img');
            imgEl.style.display = 'block';
            document.getElementById('timer-bar').style.backgroundColor = "#4ade80"; 

            // Pick Random Hero
            const r = Math.floor(Math.random() * heroes.length);
            currentHero = heroes[r];
            
            // Set Image
            if(currentHero.icon_path.startsWith('http')) {
                imgEl.src = currentHero.icon_path;
            } else {
                imgEl.src = currentHero.icon_path; 
            }

            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 15;
            isGameActive = true;
            updateTimerUI();

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerUI();

                if(timeLeft <= 0) {
                    timeIsUp();
                }
            }, 1000);
        }

        function updateTimerUI() {
            const percentage = (timeLeft / 15) * 100;
            document.getElementById('timer-bar').style.width = percentage + "%";
            document.getElementById('timer-text').innerText = timeLeft + "s";
            if(timeLeft <= 5) document.getElementById('timer-bar').style.backgroundColor = "#ef4444"; 
        }

        function timeIsUp() {
            clearInterval(timerInterval);
            isGameActive = false;

            // Show Answer
            document.getElementById('feedback').innerText = `Time's Up! It was ${currentHero.name}`;
            document.getElementById('feedback').className = "text-center font-bold text-lg h-6 mb-2 text-red-400";

            // Lock Input
            document.getElementById('guess-input').disabled = true;
            document.getElementById('btn-submit').disabled = true;

            // AUTO CONTINUE: Wait 3 seconds, then Next Round
            setTimeout(nextHero, 3000);
        }

        window.checkGuess = async function(e) {
            e.preventDefault();
            if(!isGameActive) return;

            const guess = document.getElementById('guess-input').value.toLowerCase().replace(/[^a-z0-9]/g, '');
            const answer = currentHero.name.toLowerCase().replace(/[^a-z0-9]/g, '');
            const fb = document.getElementById('feedback');

            if(guess === answer) {
                // CORRECT
                clearInterval(timerInterval);
                fb.innerText = "CORRECT!"; 
                fb.className = "text-center font-bold text-lg h-6 mb-2 text-green-400";
                
                currentUser.score++;
                document.getElementById('player-score').innerText = currentUser.score;
                
                // Disable Input
                document.getElementById('guess-input').disabled = true;
                document.getElementById('btn-submit').disabled = true;

                saveScore();
                
                // AUTO CONTINUE: Wait 1.5 seconds, then Next Round
                setTimeout(nextHero, 1500);
            } else {
                // WRONG
                document.getElementById('guess-input').value = "";
                fb.innerText = "WRONG! Try again."; 
                fb.className = "text-center font-bold text-lg h-6 mb-2 text-red-500";
            }
        }

        async function saveScore() {
            try {
                await setDoc(doc(db, "players", currentUser.id), {
                    ign: currentUser.ign,
                    score: currentUser.score,
                    updatedAt: new Date()
                }, { merge: true });
            } catch(e) { console.error("Save failed", e); }
        }

        // --- LEADERBOARD & SEARCH ---
        window.showLeaderboard = async function() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-leaderboard').classList.remove('hidden');
            const tbody = document.getElementById('lb-body');
            tbody.innerHTML = '<tr><td class="text-center text-gray-500 py-4">Loading Top 5...</td></tr>';

            try {
                const q = query(collection(db, "players"), orderBy("score", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                
                tbody.innerHTML = "";
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const p = doc.data();
                    const color = rank === 1 ? "text-yellow-400" : rank === 2 ? "text-gray-300" : rank === 3 ? "text-orange-400" : "text-white";
                    tbody.innerHTML += `<tr class="border-b border-white/5"><td class="py-3 font-black ${color}">#${rank}</td><td class="py-3 font-bold text-white">${p.ign}</td><td class="py-3 font-mono text-yellow-400 text-right">${p.score}</td></tr>`;
                    rank++;
                });
            } catch(e) { tbody.innerHTML = "<tr><td class='text-center text-red-500 py-4'>Error loading leaderboard.</td></tr>"; }
        }

        window.closeLeaderboard = function() {
            document.getElementById('screen-leaderboard').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
        }

        window.searchPlayer = async function() {
            const searchId = document.getElementById('search-id').value.trim();
            if(!searchId) return;
            const resDiv = document.getElementById('search-result');
            document.getElementById('search-rank').innerText = "...";
            resDiv.classList.remove('hidden');

            try {
                const q = query(collection(db, "players"), orderBy("score", "desc"));
                const querySnapshot = await getDocs(q);
                let rank = 1; let found = false;
                querySnapshot.forEach((doc) => {
                    if(doc.id === searchId) {
                        found = true;
                        document.getElementById('search-rank').innerText = "#" + rank;
                        document.getElementById('search-details').innerText = `${doc.data().ign} - ${doc.data().score} pts`;
                    }
                    rank++;
                });
                if(!found) {
                    document.getElementById('search-rank').innerText = "N/A";
                    document.getElementById('search-details').innerText = "Not found";
                }
            } catch(e) {
                document.getElementById('search-rank').innerText = "Error";
            }
        }
    </script>
</body>
</html>
