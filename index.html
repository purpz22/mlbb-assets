<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617">
    <title>MLBB Guess Hero</title>
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://pagead2.googlesyndication.com https://www.gstatic.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: https: http:; connect-src 'self' https://firestore.googleapis.com https://*.firebasedatabase.app https://api.isan.eu.org https://corsproxy.io wss://*.firebaseio.com https://identitytoolkit.googleapis.com;">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5350189369134605" crossorigin="anonymous"></script>
    <!-- Canvas Confetti for the correct answer celebration -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #020617; /* Slate 950 - Deep dark */
            background-image: radial-gradient(circle at top, #1e1b4b 0%, #020617 60%);
            color: #f8fafc;
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            height: 100dvh; 
            margin: 0;
            overflow: hidden;
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
        }

        /* Hide number input spinners for native feel */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* Smooth hardware acceleration */
        .gpu-layer {
            transform: translateZ(0);
            will-change: transform, opacity;
        }

        /* Custom scrollbar for leaderboard */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        /* Error shake and red flash animation */
        @keyframes error-shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-12px); }
            40%, 80% { transform: translateX(12px); }
        }
        .animate-error {
            animation: error-shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
            box-shadow: 0 0 60px rgba(225, 29, 72, 0.8), inset 0 0 20px rgba(225, 29, 72, 0.5) !important;
            border-color: #e11d48 !important;
            transition: none !important;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center w-full h-full relative">

    <!-- LOGIN SCREEN -->
    <div id="screen-login" class="w-full max-w-sm px-6 flex flex-col items-center justify-center z-10 w-full h-full gpu-layer">
        
        <div class="mb-12 text-center relative w-full flex flex-col items-center">
            <div class="absolute inset-0 bg-indigo-500/20 blur-[50px] rounded-full w-48 h-48 mx-auto -z-10 mix-blend-screen"></div>
            <h1 class="text-6xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-cyan-300 to-indigo-500 drop-shadow-[0_0_15px_rgba(56,189,248,0.3)] leading-[0.85] mb-2">
                GUESS
            </h1>
            <h2 class="text-4xl font-black italic tracking-tighter text-white drop-shadow-lg leading-none mb-1">
                THE HERO
            </h2>
            <div class="h-1 w-12 bg-indigo-500 rounded-full mt-4 shadow-[0_0_10px_rgba(99,102,241,0.8)]"></div>
        </div>

        <form id="form-login" class="w-full flex flex-col gap-4">
            <div class="flex gap-3 w-full">
                <input type="number" id="login-id" placeholder="Game ID" class="flex-1 h-16 bg-slate-900/60 backdrop-blur-md border border-slate-700/50 rounded-2xl px-5 text-xl text-center font-bold text-white placeholder-slate-500 focus:outline-none focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 transition-all shadow-inner" required>
                <input type="number" id="login-zone" placeholder="Zone" class="w-24 h-16 bg-slate-900/60 backdrop-blur-md border border-slate-700/50 rounded-2xl px-2 text-xl text-center font-bold text-white placeholder-slate-500 focus:outline-none focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 transition-all shadow-inner" required>
            </div>
            
            <p id="login-msg" class="text-red-400 text-sm h-5 font-bold text-center tracking-wide"></p>
            
            <button type="submit" id="btn-login" class="w-full h-16 mt-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-600 text-white font-black text-xl rounded-2xl shadow-[0_10px_30px_-10px_rgba(99,102,241,0.7)] active:scale-95 active:shadow-none transition-all duration-200 flex items-center justify-center uppercase tracking-widest border border-indigo-400/30">
                CONNECT
            </button>
        </form>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="w-full max-w-sm h-full px-5 py-6 flex flex-col z-10 hidden relative gpu-layer">
        
        <!-- Player Stats Floating Pill -->
        <div class="flex justify-between items-center bg-slate-900/40 border border-slate-700/50 rounded-full px-6 py-3 backdrop-blur-xl shadow-lg mb-8 shrink-0 mt-2">
            <div class="flex flex-col">
                <span class="text-[9px] text-cyan-400 font-black tracking-[0.2em] uppercase mb-0.5 opacity-80">Player</span>
                <span id="player-ign" class="font-bold text-white text-lg leading-none truncate max-w-[130px]">Name</span>
            </div>
            <div class="h-8 w-[1px] bg-slate-700/50"></div>
            <div class="flex flex-col items-end">
                <span class="text-[9px] text-indigo-400 font-black tracking-[0.2em] uppercase mb-0.5 opacity-80">Score</span>
                <span id="player-score" class="font-black text-2xl text-white leading-none drop-shadow-md">0</span>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="flex-1 flex flex-col items-center justify-center relative w-full pb-2">
            
            <!-- Timer Setup -->
            <div class="w-full flex justify-between items-end mb-2 px-2">
                <span class="text-[10px] font-black text-slate-500 tracking-widest uppercase flex items-center gap-1">
                    <div class="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-pulse"></div> TIME REMAINING
                </span>
                <span id="timer-text" class="text-cyan-300 font-black text-lg leading-none tracking-wider">15s</span>
            </div>
            
            <div class="w-full h-2 bg-slate-900 border border-slate-800 rounded-full overflow-hidden mb-10 shadow-inner relative gpu-layer">
                <div id="timer-bar" class="h-full bg-cyan-400 rounded-full origin-left w-full shadow-[0_0_12px_rgba(34,211,238,0.8)]"></div>
            </div>
            
            <!-- Hero Showcase (Strictly Circular) -->
            <div class="relative w-64 h-64 flex items-center justify-center mb-8 isolate shrink-0">
                <!-- Dual Glowing Rings -->
                <div class="absolute inset-0 bg-gradient-to-tr from-cyan-500 to-indigo-500 rounded-full blur-[40px] opacity-30 -z-10 animate-pulse"></div>
                
                <!-- Main Container strictly enforcing image rules -->
                <div class="hero-box w-[220px] h-[220px] rounded-full p-1.5 bg-gradient-to-b from-slate-700 to-slate-900 shadow-[0_20px_50px_rgba(0,0,0,0.5)] transition-all duration-300 relative flex items-center justify-center" id="hero-box">
                    <div class="w-full h-full rounded-full overflow-hidden bg-slate-950 flex items-center justify-center relative z-10 border border-slate-800/80">
                        <img id="hero-img" src="" alt="Hero" class="w-full h-full object-cover scale-[1.02]">
                    </div>
                    <!-- Debug text absolutely positioned on top if needed -->
                    <div id="debug-msg" class="absolute inset-0 flex items-center justify-center bg-slate-900/95 text-red-500 text-xs font-bold text-center px-4 break-words hidden z-20 rounded-full"></div>
                </div>
            </div>
            
            <!-- Feedback Text (JS changes text color, pre-styled base) -->
            <p id="feedback" class="text-center font-bold text-xl h-7 mb-2 tracking-wide"></p>
        </div>

        <!-- Controls Area -->
        <div class="w-full shrink-0 flex flex-col gap-3 pb-safe">
            <form id="form-guess" class="flex flex-col gap-3 w-full">
                <input type="text" id="guess-input" placeholder="ENTER HERO" class="w-full h-16 bg-slate-900/80 backdrop-blur-md border-2 border-slate-700 rounded-full px-6 text-2xl text-center font-black text-cyan-300 placeholder-slate-600 uppercase tracking-[0.15em] focus:outline-none focus:border-indigo-500 focus:bg-slate-800 transition-all shadow-inner" autocomplete="off" autocorrect="off" spellcheck="false">
                <button type="submit" id="btn-submit" class="w-full h-16 bg-white text-slate-950 font-black text-xl rounded-full uppercase tracking-[0.2em] shadow-[0_8px_20px_rgba(255,255,255,0.2)] active:scale-95 active:shadow-none transition-all duration-200 flex items-center justify-center">
                    SUBMIT
                </button>
            </form>

            <button id="btn-show-leaderboard" class="h-14 w-full flex items-center justify-center bg-slate-800/60 backdrop-blur-sm border border-slate-700/80 rounded-full text-cyan-400 font-bold text-sm uppercase tracking-[0.15em] active:bg-slate-700 active:text-cyan-300 transition-all mt-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                Open Leaderboard
            </button>
        </div>
    </div>

    <!-- LEADERBOARD SCREEN -->
    <div id="screen-leaderboard" class="fixed inset-0 bg-slate-950/95 backdrop-blur-3xl z-50 hidden flex-col gpu-layer">
        <div class="flex-1 w-full max-w-md mx-auto flex flex-col h-full px-5 py-6">
            
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 pt-4 shrink-0">
                <div class="flex flex-col">
                    <span class="text-[10px] text-cyan-500 font-black tracking-widest uppercase">Global</span>
                    <h2 class="text-3xl font-black text-white italic tracking-tighter leading-none mt-1">TOP 5</h2>
                </div>
                <button id="btn-close-leaderboard" class="h-10 w-10 bg-slate-800 border border-slate-700 rounded-full flex items-center justify-center text-slate-400 active:scale-90 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Table Card Area -->
            <div class="flex-1 overflow-y-auto overscroll-contain mb-4 relative pb-4">
                <table class="w-full text-left border-collapse">
                    <tbody id="lb-body" class="block w-full">
                        <tr class="w-full"><td class="text-center text-slate-500 py-10 font-bold w-full text-sm tracking-widest uppercase">Loading Data...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Search Area Bottom Sheet Style -->
            <div class="shrink-0 bg-slate-900 border border-slate-800 rounded-3xl p-5 shadow-2xl relative overflow-hidden">
                <!-- Glossy accent -->
                <div class="absolute top-0 left-0 right-0 h-[1px] bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>
                
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-3 text-center">Locate Player Rank</p>
                <form id="form-search" class="flex gap-2">
                    <input type="number" id="search-id" placeholder="Game ID" class="flex-1 h-14 bg-slate-950 border border-slate-800 rounded-2xl px-4 text-center font-bold text-white placeholder-slate-600 focus:outline-none focus:border-indigo-500 transition-colors shadow-inner" required>
                    <button type="submit" class="h-14 px-6 bg-indigo-600 text-white font-black text-sm uppercase tracking-widest rounded-2xl active:bg-indigo-700 active:scale-95 transition-all shadow-lg shadow-indigo-500/30">
                        FIND
                    </button>
                </form>
                
                <div id="search-result" class="mt-4 bg-slate-950 border border-slate-800 rounded-2xl p-4 hidden flex-col items-center justify-center transition-all">
                    <p id="search-rank" class="text-4xl font-black text-cyan-400 drop-shadow-[0_0_10px_rgba(34,211,238,0.5)] leading-none">#0</p>
                    <p id="search-details" class="text-sm font-bold text-slate-300 mt-2 tracking-wide">IGN - 0 pts</p>
                </div>
            </div>

        </div>
    </div>

    <!-- APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
            authDomain: "guesshero-e1180.firebaseapp.com",
            databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "guesshero-e1180",
            storageBucket: "guesshero-e1180.firebasestorage.app",
            messagingSenderId: "274899168100",
            appId: "1:274899168100:web:da9798cf93110516d8e871"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Data Generation Logic
        const uniqueHeroNames = new Set([
            "Lunox", "Luo Yi", "Zhuxin", "Chip", "Cici", "Nolan", "Arlott", "Novaria", "Joy", "Fredrinn", 
            "Julian", "Xavier", "Melissa", "Yin", "Floryn", "Edith", "Valentina", "Aamon", "Aulus", "Natan", 
            "Phoveus", "Beatrix", "Gloo", "Paquito", "Mathilda", "Yve", "Brody", "Barats", "Khaleed", "Benedetta", 
            "Atlas", "Carmilla", "Cecilion", "Silvanna", "Wanwan", "Masha", "Baxia", "Ling", "X.borg", "Terizla", 
            "Esmeralda", "Guinevere", "Granger", "Khufra", "Badang", "Faramis", "Kadita", "Minotaur", "Hanzo", 
            "Claude", "Aldous", "Selena", "Kaja", "Chang'e", "Thamuz", "Kimmy", "Belerick", "Leomord", "Vale", 
            "Hanabi", "Uranus", "Martis", "Valir", "Gusion", "Angela", "Jawhead", "Lesley", "Pharsa", "Helcurt", 
            "Zhask", "Hylos", "Diggie", "Lancelot", "Odette", "Argus", "Grock", "Irithel", "Harley", "Gatotkaca", 
            "Roger", "Vexana", "Lapu-Lapu", "Aurora", "Hilda", "Estes", "Cyclops", "Johnson", "Moskov", 
            "Yi Sun shin", "Ruby", "Alpha", "Sun", "Chou", "Kagura", "Natalia", "Gord", "Freya", "Hayabusa", 
            "Lolita", "Layla", "Zilong", "Eudora", "Rafaela", "Clint", "Bruno", "Bane", "Franco", "Akai", "Karina", 
            "Alucard", "Miya", "Saber", "Balmond", "Nana", "Alice", "Zetian", "Sora", "Obsedia"
        ]);

        const predefinedSeriesSkins = [
            { name: "Chou", icon_path: "icons/chou-kof1.png" },
            { name: "Gusion", icon_path: "icons/gusion-KOF2.png" },
            { name: "Guinevere", icon_path: "icons/guinevere-kof1.png" },
            { name: "Karina", icon_path: "icons/karina-kof1.png" }
        ];

        const heroes = [];
        const normalizeName = (name) => name.toLowerCase().replace(/[' .]/g, '-').replace(/\.+$/, '');

        uniqueHeroNames.forEach(heroName => {
            if (heroName === "Fanny") return;
            const baseName = normalizeName(heroName);
            heroes.push({ name: heroName, icon_path: `icons/${baseName}-ss.webp` });
            heroes.push({ name: heroName, icon_path: `icons/${baseName}-1st.png` });
            heroes.push({ name: heroName, icon_path: `icons/${baseName}-icon.webp` });
        });
        predefinedSeriesSkins.forEach(skin => heroes.push({ name: skin.name, icon_path: skin.icon_path }));

        // Game State
        let currentUser = { id: "", ign: "", score: 0 };
        let currentHero = null;
        let timerInterval = null;
        let isGameActive = false;
        const MAX_TIME = 15;

        // DOM Elements Mapping
        const els = {
            screenLogin: document.getElementById('screen-login'),
            screenGame: document.getElementById('screen-game'),
            screenLeaderboard: document.getElementById('screen-leaderboard'),
            loginMsg: document.getElementById('login-msg'),
            playerIgn: document.getElementById('player-ign'),
            playerScore: document.getElementById('player-score'),
            timerText: document.getElementById('timer-text'),
            timerBar: document.getElementById('timer-bar'),
            heroImg: document.getElementById('hero-img'),
            debugMsg: document.getElementById('debug-msg'),
            feedback: document.getElementById('feedback'),
            guessInput: document.getElementById('guess-input'),
            btnSubmit: document.getElementById('btn-submit'),
            heroBox: document.getElementById('hero-box')
        };

        // Event Listeners Initialization
        document.getElementById('form-login').addEventListener('submit', handleLogin);
        document.getElementById('form-guess').addEventListener('submit', checkGuess);
        document.getElementById('btn-show-leaderboard').addEventListener('click', openLeaderboard);
        document.getElementById('btn-close-leaderboard').addEventListener('click', closeLeaderboard);
        document.getElementById('form-search').addEventListener('submit', searchPlayer);
        els.heroImg.addEventListener('error', handleImageError);

        // Android Hardware Back Button Handling (History API Hook)
        window.addEventListener('popstate', (event) => {
            if (els.screenLeaderboard.classList.contains('hidden') === false) {
                closeLeaderboard(null, true);
            }
        });

        // Application Logic
        async function handleLogin(e) {
            e.preventDefault();
            if (!navigator.onLine) {
                els.loginMsg.innerText = "No internet connection.";
                return;
            }

            const id = document.getElementById('login-id').value.trim();
            const zone = document.getElementById('login-zone').value.trim();
            
            // Input Validation
            if (!/^\d+$/.test(id) || !/^\d+$/.test(zone)) {
                els.loginMsg.innerText = "Invalid ID/Zone format.";
                return;
            }

            els.loginMsg.innerText = "Verifying Account...";
            document.getElementById('btn-login').disabled = true;

            try {
                // WARNING: Architecture flaw. Replace corsproxy.io with a dedicated Cloud Function
                const res = await fetch(`https://api.isan.eu.org/nickname/ml?id=${id}&zone=${zone}`);
                const data = await res.json();
                
                if (!data.success && !data.name && !data.nickname) {
                    throw new Error("Invalid ID or Zone");
                }
                
                currentUser.id = id;
                currentUser.ign = data.name || data.nickname;
                els.loginMsg.innerText = "Loading Score...";

                // Fetch Firebase profile
                const userDoc = await getDoc(doc(db, "players", id));
                currentUser.score = userDoc.exists() ? userDoc.data().score : 0;

                switchScreen(els.screenLogin, els.screenGame);
                els.playerIgn.innerText = currentUser.ign;
                els.playerScore.innerText = currentUser.score;
                
                nextHero();
            } catch(e) { 
                els.loginMsg.innerText = "Error: " + e.message; 
            } finally {
                document.getElementById('btn-login').disabled = false;
            }
        }

        function nextHero() {
            els.guessInput.value = "";
            els.guessInput.disabled = false;
            els.btnSubmit.disabled = false;
            els.feedback.innerText = "";
            els.debugMsg.classList.add('hidden');
            els.heroImg.style.display = 'block';
            els.timerBar.style.backgroundColor = "#22d3ee"; // Adjusted to match cyan theme

            currentHero = heroes[Math.floor(Math.random() * heroes.length)];
            els.heroImg.src = currentHero.icon_path;
            
            // Auto-focus keyboard safely allowing native threads to catch up
            setTimeout(() => els.guessInput.focus(), 100);

            startTimer();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            isGameActive = true;
            
            let timeLeft = MAX_TIME;
            els.timerText.innerText = `${timeLeft}s`;

            // Reset visual bar immediately (Force DOM Reflow)
            els.timerBar.style.transition = 'none';
            els.timerBar.style.transform = 'scaleX(1)';
            void els.timerBar.offsetWidth; 

            // Start native CSS hardware accelerated animation
            els.timerBar.style.transition = `transform ${MAX_TIME}s linear, background-color 0.3s`;
            els.timerBar.style.transform = 'scaleX(0)';

            timerInterval = setInterval(() => {
                timeLeft--;
                els.timerText.innerText = `${timeLeft}s`;

                if (timeLeft <= 5) els.timerBar.style.backgroundColor = "#f43f5e"; // Rose-500

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timeIsUp();
                }
            }, 1000);
        }

        function timeIsUp() {
            isGameActive = false;
            els.feedback.innerText = `Time's Up! It was ${currentHero.name}`;
            els.feedback.className = "text-center font-bold text-xl h-7 mb-2 text-rose-500 tracking-wide";
            lockGame(3000);
        }

        async function checkGuess(e) {
            e.preventDefault();
            if (!isGameActive) return;

            // Strict string normalization for input evaluation
            const guess = els.guessInput.value.toLowerCase().replace(/[^a-z0-9]/g, '');
            const answer = currentHero.name.toLowerCase().replace(/[^a-z0-9]/g, '');

            if (guess === answer) {
                clearInterval(timerInterval);
                isGameActive = false;
                els.timerBar.style.transition = 'none'; // Freeze timer visual
                
                els.feedback.innerText = "CORRECT!"; 
                els.feedback.className = "text-center font-black text-xl h-7 mb-2 text-cyan-400 tracking-[0.2em] drop-shadow-[0_0_8px_rgba(34,211,238,0.5)]";
                
                currentUser.score++;
                els.playerScore.innerText = currentUser.score;
                
                // Trigger Confetti
                if (window.confetti) {
                    confetti({
                        particleCount: 120,
                        spread: 80,
                        origin: { y: 0.6 },
                        colors: ['#22d3ee', '#818cf8', '#f8fafc', '#a78bfa'], // cyan, indigo, white, purple
                        disableForReducedMotion: true
                    });
                }

                lockGame(1500);
                saveScore(); // Async fire-and-forget to avoid blocking main thread
            } else {
                els.guessInput.value = "";
                els.feedback.innerText = "WRONG! Try again."; 
                els.feedback.className = "text-center font-bold text-xl h-7 mb-2 text-rose-500 tracking-wide";

                // Trigger shake and red flash error animation
                els.heroBox.classList.add('animate-error');
                setTimeout(() => {
                    els.heroBox.classList.remove('animate-error');
                }, 400);
            }
        }

        function lockGame(timeoutDelay) {
            els.guessInput.disabled = true;
            els.btnSubmit.disabled = true;
            setTimeout(nextHero, timeoutDelay);
        }

        function saveScore() {
            if (!navigator.onLine) return; // Rely on Firebase offline persistence later if needed
            setDoc(doc(db, "players", currentUser.id), {
                ign: currentUser.ign,
                score: currentUser.score,
                updatedAt: new Date()
            }, { merge: true }).catch(console.error);
        }

        function handleImageError() {
            els.heroImg.style.display = 'none';
            els.debugMsg.innerText = `Image Missing: ${els.heroImg.getAttribute('src')}`;
            els.debugMsg.classList.remove('hidden');
        }

        // View Routing & State Management
        function switchScreen(hideEl, showEl) {
            hideEl.classList.add('hidden');
            hideEl.classList.remove('flex');
            showEl.classList.remove('hidden');
            showEl.classList.add('flex');
        }

        async function openLeaderboard(e) {
            if(e) e.preventDefault();
            history.pushState({ page: 'leaderboard' }, ''); // Pushes to history for Android Back button
            switchScreen(els.screenGame, els.screenLeaderboard);
            
            const tbody = document.getElementById('lb-body');
            tbody.innerHTML = '<tr class="w-full"><td class="text-center text-slate-500 py-10 font-bold w-full text-sm tracking-widest uppercase animate-pulse">Loading Top 5...</td></tr>';

            try {
                const q = query(collection(db, "players"), orderBy("score", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                
                tbody.innerHTML = "";
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const p = doc.data();
                    // Basic XSS mitigation before injecting into DOM via innerHTML
                    const safeIgn = p.ign.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const color = rank === 1 ? "text-cyan-400 drop-shadow-[0_0_5px_rgba(34,211,238,0.6)]" : rank === 2 ? "text-slate-200" : rank === 3 ? "text-indigo-400" : "text-slate-500";
                    tbody.innerHTML += `
                        <tr class="w-full flex items-center bg-slate-900/60 border border-slate-800 rounded-2xl mb-2 px-4 py-3 shadow-sm">
                            <td class="font-black text-xl w-10 text-center ${color}">#${rank}</td>
                            <td class="font-bold text-white truncate flex-1 px-3 tracking-wide">${safeIgn}</td>
                            <td class="font-black text-white text-right w-16 text-lg tracking-wider">${p.score}</td>
                        </tr>`;
                    rank++;
                });
            } catch(err) { 
                tbody.innerHTML = "<tr class='w-full'><td class='text-center text-red-500 py-10 font-bold w-full text-sm tracking-widest uppercase'>Error loading leaderboard.</td></tr>"; 
            }
        }

        function closeLeaderboard(e, fromPopState = false) {
            if(e) e.preventDefault();
            if (!fromPopState) history.back(); // Triggers OS-level back navigation
            switchScreen(els.screenLeaderboard, els.screenGame);
        }

        async function searchPlayer(e) {
            e.preventDefault();
            const searchId = document.getElementById('search-id').value.trim();
            if (!searchId) return;
            
            const resDiv = document.getElementById('search-result');
            document.getElementById('search-rank').innerText = "...";
            resDiv.classList.remove('hidden');
            resDiv.classList.add('flex');

            try {
                const q = query(collection(db, "players"), orderBy("score", "desc"));
                const querySnapshot = await getDocs(q);
                let rank = 1, found = false;
                
                for (const playerDoc of querySnapshot.docs) {
                    if (playerDoc.id === searchId) {
                        found = true;
                        const safeIgn = playerDoc.data().ign.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        document.getElementById('search-rank').innerText = `#${rank}`;
                        document.getElementById('search-details').innerHTML = `${safeIgn} <span class="text-slate-500 mx-1">â€¢</span> <span class="text-white">${playerDoc.data().score} pts</span>`;
                        break;
                    }
                    rank++;
                }
                
                if (!found) {
                    document.getElementById('search-rank').innerText = "-";
                    document.getElementById('search-details').innerText = "Player not found";
                }
            } catch(err) {
                document.getElementById('search-rank').innerText = "!";
                document.getElementById('search-details').innerText = "Search Error";
            }
        }
    </script>
</body>
</html>